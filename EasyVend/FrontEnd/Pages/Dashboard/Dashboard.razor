@rendermode InteractiveServer
@page "/dashboard"
@attribute [Authorize]
@using EasyVend.FrontEnd.Components.Dashboard
@inject EasyVend.Services.UserService UserService
@inject NavigationManager Nav

<div class="container-fluid dashboard-page">
    <div class="row">
        <div class="col-12 col-md-3 col-lg-2 mb-3">
            <SidebarMenu SelectedPage="@_selected" SelectedPageChanged="OnSelectedPageChanged" />
        </div>
        <div class="col-12 col-md-9 col-lg-10">
            <DashboardDisplay SelectedPage="@_selected" />
        </div>
    </div>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthStateTask { get; set; }
    private bool _checked;
    private string _selected = "Overview";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checked) return;
        _checked = true;

        try
        {
            if (AuthStateTask is null)
            {
                // No auth state available; don't crash the circuit
                return;
            }

            var auth = await AuthStateTask;
            var principal = auth?.User;
            if (principal is null || !(principal.Identity?.IsAuthenticated ?? false))
            {
                // Not authenticated yet in this circuit
                return;
            }

            var user = await UserService.EnsureUserExistsAsync(principal);
            if (!UserService.IsProfileComplete(user))
            {
                Nav.NavigateTo("/setup-profile", replace: true);
            }
        }
        catch
        {
            // Swallow to avoid circuit termination; errors are logged in UserService
        }
    }

    private void OnSelectedPageChanged(string page)
    {
        _selected = page;
        StateHasChanged();
    }
}